<div class="row justify-content-center">
    <div class="form-container p-4 w-100">
        <form id="eventForm" action="<%= event ? `/api/events/${event.ID}/update` : '/api/events/' %>" method="POST">
            <div class="form-group">
                <label for="title">Título del Evento</label>
                <input 
                    type="text" 
                    class="form-control" 
                    id="title" 
                    name="title" 
                    placeholder="Ingresa el título del evento" 
                    value="<%= event ? event.Title : '' %>" 
                    required
                >
                <span id="titleError" class="error-text" style="display: none;"></span> 
            </div>

            <div class="form-group">
                <label for="description">Descripción</label>
                <textarea 
                    class="form-control" 
                    id="description" 
                    name="description" 
                    rows="4" 
                    placeholder="Descripción del evento"
                ><%= event ? event.Description : '' %></textarea>
                <span id="descriptionError" class="error-text" style="display: none;"></span> 
            </div>

            <div class="form-group">
                <label for="dateTime">Fecha y Hora</label>
                <input 
                    type="datetime-local" 
                    class="form-control" 
                    id="dateTime" 
                    name="dateTime" 
                    value="<%= event ? new Date(event.DateTime).toISOString().slice(0, 16) : '' %>" 
                    required
                >
                <span id="dateTimeError" class="error-text" style="display: none;"></span> 
            </div>

            <div class="form-group">
                <label for="location">Ubicación</label>
                <select 
                    class="form-control" 
                    id="location" 
                    name="location" 
                    required
                >
                    <% if (facultyList && facultyList.length) { %>
                        <% facultyList.forEach(faculty => { %>
                            <option 
                                value="<%= faculty.ID %>" 
                                <%= event && event.Location === faculty.ID ? 'selected' : '' %>>
                                <%= faculty.Name %>, <%= faculty.University %>
                            </option>
                        <% }) %>
                    <% } else { %>
                        <option disabled>No hay facultades disponibles</option>
                    <% } %>
                </select>
                <span id="locationError" class="error-text" style="display: none;"></span>
            </div>

            <div class="form-group">
                <label for="capacity">Capacidad</label>
                <input 
                    type="number" 
                    class="form-control" 
                    id="capacity" 
                    name="capacity" 
                    placeholder="Capacidad del evento"
                    value="<%= event ? event.Capacity : '' %>"
                    min="1" 
                >
                <span id="capacityError" class="error-text" style="display: none;"></span> 
            </div>

            <div class="form-group">
                <label for="eventTypeID">Tipo de Evento</label>
                <select class="form-control" id="eventTypeID" name="eventTypeID" required>
                    <% if (eventTypeList && eventTypeList.length) { %>
                        <% eventTypeList.forEach(eventType => { %>
                            <option value="<%= eventType.ID %>" <%= event && event.EventTypeID === eventType.ID ? 'selected' : '' %> >
                                <%= eventType.Name %>
                            </option>
                        <% }) %>
                    <% } else { %>
                        <option disabled>No hay tipos de eventos disponibles</option>
                    <% } %>
                </select>
                <span id="eventTypeIDError" class="error-text" style="display: none;"></span>
            </div>

            <div class="d-flex justify-content-between">
                <button type="submit" class="btn btn-success w-100">
                    <%= event ? "Editar Evento" : "Crear Evento" %>
                </button>
            </div>
        </form>
    </div>
</div>
<div aria-live="polite" aria-atomic="true" style="position: fixed; bottom: 10px; right: 10px; z-index: 100;">
    <div id="toast" class="toast toast-error">
        <div class="toast-body" id="toastMessage"></div>
    </div>
</div>


<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    $(document).ready(function() {
        $('#eventForm').submit(function(event) {
            event.preventDefault(); 
            
            $('.error-text').hide().text('');

            const title = $('#title').val().trim();
            const description = $('#description').val().trim();
            const dateTime = $('#dateTime').val().trim();
            const location = $('#location').val().trim();
            const capacity = $('#capacity').val().trim();
            const eventTypeID = $('#eventTypeID').val().trim();

            let isValid = true;

            if (!title) {
                $('#titleError').text("El título es obligatorio").show();
                isValid = false;
            }

            const datePattern = /^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}$/;
            if (!datePattern.test(dateTime)) {
                $('#dateTimeError').text("La fecha y hora deben estar en un formato válido").show();
                isValid = false;
            }

            if (!location) {
                $('#locationError').text("La ubicación es obligatoria").show();
                isValid = false;
            }

            if (isNaN(capacity) || capacity <= 0) {
                $('#capacityError').text("La capacidad debe ser un número positivo").show();
                isValid = false;
            }

            if (!eventTypeID) {
                $('#eventTypeIDError').text("El tipo de evento es obligatorio").show();
                isValid = false;
            }

            if (!isValid) {
                return; 
            }

            $.ajax({
                url: $('#eventForm').attr('action'), 
                method: 'POST',
                data: {
                    title: title,
                    description: description,
                    dateTime: dateTime,
                    location: location,
                    capacity: capacity,
                    eventTypeID: eventTypeID
                },
                success: function(response) {
                    window.location.href = '/events';  
                },
                error: function(xhr, status, error) {
                    let errorMessage = "Error al crear el evento.";
                    if (xhr.responseJSON && xhr.responseJSON.error) {
                        errorMessage = xhr.responseJSON.error;
                    }
                    console.log(errorMessage)
                    $('#toastMessage').text(errorMessage);
                    $('#toast').toast('show');
                }
            });
        });
    });

   
</script>

